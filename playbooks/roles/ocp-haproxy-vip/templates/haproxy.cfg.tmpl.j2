defaults
  maxconn 20000
  mode    tcp
  log     /var/run/haproxy/haproxy-log.sock local0
  option  dontlognull
  retries 3
  timeout http-keep-alive 10s
  timeout http-request    1m
  timeout queue           1m
  timeout connect         10s
  timeout client          86400s
  timeout server          86400s
  timeout tunnel          86400s

listen health_check_http_url
  bind :::50936 v4v6
  mode http
  monitor-uri /readyz
  option dontlognull
listen stats
  bind :::9000
  mode http
  stats enable
  stats hide-version
  stats uri /
  stats refresh 30s
  #stats auth Username:Password

frontend  main
  bind :::9445 v4v6
  default_backend masters

backend masters
   option  httpchk GET /healthz HTTP/1.0
   option  log-health-checks
   balance roundrobin
{% for m in groups['masters'] %}
   server master-{{ loop.index0 }} {{ m }}:6443 weight 1 verify none check check-ssl inter 3s fall 2 rise 3
{% endfor %}

frontend ingress-http
    bind *:80
    default_backend ingress-http
    mode tcp
    option tcplog

backend ingress-http
    balance source
    mode tcp
{% for w in groups['workers'] %}
    server worker-{{ loop.index0 }} {{ w }}:80 check
{% endfor %}
   
frontend ingress-https
    bind *:443
    default_backend ingress-https
    mode tcp
    option tcplog

backend ingress-https
    balance source
    mode tcp
{% for w in groups['workers'] %}
    server worker-{{ loop.index0 }} {{ w }}:443 check
{% endfor %}
